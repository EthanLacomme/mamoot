{% extends "layout.html.twig" %}

{% block title %}Jouer{% endblock %}

{% block css %}<link rel="stylesheet" href="{{ asset("css/play.css") }}">{% endblock %}

{% block main %}

    <div class="game-container">
        <div class="pending">
            <div class="header">
                <h2 id="quiz_name">Nom du quiz</h2>
                <span id="question_number">999</span>
                <span id="code">999999</span>
            </div>

            <ul id="participants">

            </ul>

            <button id="start">Lancer le quiz</button>
        </div>

        <div class="timer-start" style="display: none">
            <span id="timer-start-time">5</span>
        </div>

        <div class="progress" style="display: none">
            <div class="header">
                <span id="timer">30</span>
                <span><span id="progression">30</span>/<span id="total_questions"></span></span>
            </div>

            <div class="question-content">
                <p id="question"></p>
            </div>

            <div class="questions">

            </div>

            <div class="btns">
                <button class="btn" id="next">Passer la question</button>
            </div>
        </div>

        <div class="resultat" style="display: none">
            <div class="hidden-resultat">
                <button class="btn" id="afficher_resultat">Afficher les resultats</button>
            </div>

            <div class="content-resutlat" style="display: none">

                <div>
                    <div id="bonne_reponse"></div>
                    <div id="mauvaise_reponse"></div>
                </div>

                <div class="question-content">
                    <p id="question-resultat"></p>
                </div>

                <div class="questions-resultat">

                </div>

                <div class="btns">
                    <button class="btn" id="nextQuestion" onclick="nextQuestion()">Question suivante</button>
                    <button class="btn" id="finishQuiz" onclick="finishQuiz()" style="display: none">Finir le Quiz</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        var socket = io("http://localhost:5000");
        var participantsHTML = $('#participants');
        var codeRoom = 0;
        var current_question = 0;
        var quiz;
        let timer_countdown;
        let total_participants = 0;

        socket.on("room", ({ quiz_reponse, code }) => {
            $('#quiz_name').html(quiz_reponse.title);
            $('#question_number').html(quiz_reponse.questions.length);
            $('#code').html(code);
            codeRoom = code;
            quiz = quiz_reponse;
        });

        socket.on("newConnected", ({ id, username }) => {
            total_participants++;

            participantsHTML.append($("<li>")
                .attr("id", id)
                .addClass("participant")
                .append(
                    $("<span>")
                        .text(username)
                )
                .append(
                    $("<button>")
                        .click(function () {
                            $("#" + id).remove();
                            socket.emit("kickedPlayer", {
                                id: id,
                                code: codeRoom
                            })
                        })
                        .text("Virer le joueur")
                )
            );
        })

        socket.on("newDisconnected", ({ id }) => {
            $("#" + id).remove();
        })

        $(document).ready(function(){

            $('#next').click(function(){
                if(timer_countdown > 1){
                    timer_countdown = 1;
                    socket.emit("skipQuestion", {
                        current_question: current_question - 1,
                        id: {{ id_user }}
                    })
                }
            })

            $(window).on('beforeunload', function(){
                socket.emit("disconnecting", { userId: {{ id_user }} });
                socket.close();
            });

            $.ajax({
                url: "{{ path("get_data") }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    "id_user": {{ id_user }},
                    "id_quiz": {{ id_quiz }}
                }),
                success: function(res){
                    socket.emit("createdRoom", {
                        id_user: {{ id_user }},
                        quiz: res.quiz
                    })
                }
            })

            $('#start').click(function(){

                $('.pending').hide();

                $('.timer-start').show();

                let countdown = 4;

                function updateCountdown() {

                    $('#timer-start-time').text(countdown);

                    if (countdown === 0) {
                        clearInterval(interval);
                        socket.emit("startGame", {
                            id: {{ id_user }}
                        })
                        $('#timer-start-time').hide();
                        nextQuestion();
                    } else {
                        countdown--;
                    }
                }

                let interval = setInterval(updateCountdown, 1000);

            })

            $('#afficher_resultat').click(function(){
                $('.hidden-resultat').hide();
                $('.content-resutlat').show();
            })
        })

        function finishQuiz(){

            $.ajax({
                url: "http://localhost:5000/get_resultat_finish",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    id: {{ id_user }}
                }),
                success: function(res){

                    $.ajax({
                        url: "{{ path("set_session_quiz") }}",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({
                            resultat: res.resultat
                        }),
                        success: function(resultat){
                            window.location.href = "{{ path("finish_quiz") }}";
                        }
                    })

                }
            })

        }

        function nextQuestion(){
            $('.progress').show();
            $('.resultat').hide();
            $('.hidden-resultat').show();
            $('.content-resutlat').hide();
            current_question++;

            if(current_question === quiz.questions.length){
                $('#nextQuestion').hide();
                $('#finishQuiz').show();
            }

            if(current_question !== 1){
                socket.emit("nextQuestion", {
                    id: {{ id_user }}
                })
            }

            let question = quiz.questions[current_question - 1];

            $('#timer').text(question.temps);
            $('#total_questions').text(quiz.questions.length);
            $('#progression').text(current_question);
            $('#question').text(question.label);
            timer_countdown = question.temps;

            $('#question').text(question.label);

            $('.questions').html("");

            if(question.vraifaux){
                $('.questions')
                    .append(
                        $('<div>')
                            .addClass("reponse")
                            .text("Vrai")
                    )
                    .append(
                        $("<div>")
                            .addClass('reponse')
                            .text("Faux")
                    )
            } else if(question.curseur){

            } else {
                for(let i = 0; i < question.reponses.length; i++){
                    $('.questions')
                        .append(
                            $('<div>')
                                .addClass("reponse")
                                .text(question.reponses[i].reponse)
                        )
                }
            }

            function updateCountdown() {

                $('#timer').text(timer_countdown);

                if (timer_countdown === 0) {
                    clearInterval(interval);
                    $('.progress').hide();
                    afficherResultat();
                } else {
                    timer_countdown--;
                }
            }

            let interval = setInterval(updateCountdown, 1000);
        }

        function afficherResultat(){
            $('.resultat').show();

            $.ajax({
                url: "http://localhost:5000/get_resultat",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    current_question: current_question - 1,
                    id: {{ id_user }}
                }),
                success: function(res){
                    $('#bonne_reponse').text(
                        `Bonne réponse : ${res.bonne_reponse} ✔️`
                    )
                    $("#mauvaise_reponse").text(
                        `Mauvaise réponse : ${total_participants - res.bonne_reponse} ❌`
                    )

                    socket.emit("afficherResultat", {
                        id: {{ id_user }},
                        current_question: current_question - 1
                    });

                    let question = quiz.questions[current_question - 1];

                    $('.questions-resultat').html("");

                    $("#question-resultat").text(question.label);

                    if(question.vraifaux){
                        $('.questions-resultat')
                            .append(
                                $('<div>')
                                    .addClass("reponse-resultat")
                                    .text(`Vrai ${question.valeurvraifaux ? " ✔️" : " ❌"}`)
                            )
                            .append(
                                $("<div>")
                                    .addClass('reponse')
                                    .text(`Faux ${question.valeurvraifaux ? " ❌" : " ✔️"}`)
                            )
                    } else if(question.curseur){
                        $('.questions-resultat')
                            .append(
                                $("<p>")
                                    .addClass("reponse-resultat")
                                    .text(
                                        question.minimum_valide === question.maximum_valide ?
                                            `La bonne réponse est ${question.minimum_valide}` :
                                            `La bonne réponse est comprise entre ${question.minimum_valide} et ${question.maximum_valide}`
                                    )
                            )
                    } else {
                        for(let i = 0; i < question.reponses.length; i++){
                            $('.questions-resultat')
                                .append(
                                    $('<div>')
                                        .addClass("reponse-resultat")
                                        .text(`${question.reponses[i].reponse} ${question.reponses[i].good ? " ✔️" : " ❌"}`)
                                )
                        }
                    }
                }
            })
        }
    </script>

{% endblock %}